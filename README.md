# ch32v003fun_shenanigans
This is a place for my ch32v003fun related mini-projects. Don't mind me, I'm just doodling here.

## HiVoPuCounter: This module is designed to log the information of a (here) Xenon-flashbulb that can be used to approximate the remaining life-time of it to be able to get good use out of each lamp but also prevents damage to optical components due to a light-bulb going through an unscheduled disassembly process. The energy of each pulse is dependent on the voltage across the discharge capacitor (bank), so logging the voltage and the amount of discharges at this same-ish voltage is done by storing the voltage (here: 400V..3200V) by dividing this voltage range into (here) 100 bins. Each bin stores the amount of discharges within that voltage binning and stores the number of discharges with uint32 to avoid value overflows in any practical scenario. The voltages below 400V is not relevant as the lamp will not fire consistently below that voltage (in the target unit). The logging data is stored inside an FRAM to have a persistant log of the data. 
The main loop of the logging firmware runs with 1 kHz (here) and samples an analog voltage equivalent to a much higher voltage across the capacitor (bank). A discharge event is detected by calculating the differenz between the current analog sample and the rolling average of this value. When a certain difference is reached, a discharge event for a specific voltage bin is incremented by one, and the discharge detection routine gets overridden for a certain amount of time (depends on the application) to prevent counting multiple discharges in case of an unusually long pulse. The target flasher design operates at 1Hz repetition rate to keep the thermal stress on the bulbs managable, which gives this logger ample time to output diagnostic data over the UART and the optional OLED display between two discharge events. This detection method only counts the sharp dips in the voltage that occur in an discharge event and will ignore the slow decline of the voltage level that happens while deenergizing the device.
